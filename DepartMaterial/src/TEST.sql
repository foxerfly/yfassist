

DECLARE @PH CHAR(20)
SET @PH='E0101-05326-01'



		--可补工单号
			SELECT TB001,TB002, CASE WHEN TB005-TB027>=0 THEN (TB004-TB005)-ISNULL(TE005,0) WHEN TB005-TB027<0 THEN (TB004-TB027)-ISNULL(TE005,0) ELSE 0 END TTE,TA009
			FROM  MOCTB
			LEFT JOIN MOCTA ON TB001=TA001 AND TB002=TA002
			LEFT JOIN(SELECT ISNULL(SUM(TE005),0) TE005 ,TE004,TE011,TE012 FROM MOCTE  LEFT JOIN MOCTC ON TC001=TE001 AND TC002=TE002 WHERE TC009='N' GROUP BY TE011,TE012,TE004) AS A  ON TE011=MOCTA.TA001 AND TE012=TA002 AND TE004=TB003
			WHERE TA013='Y' AND TA011<>'Y' AND TA011<>'y' AND TA011<>'1' AND MOCTA.TA001+MOCTA.TA002 IN(SELECT TC004+TC005 FROM SFCTC WHERE TC004=MOCTA.TA001 AND TC005=MOCTA.TA002 AND TC022='Y')
			AND TB003=@PH  --AND SUBSTRING(MOCTA.TA001,1,2)='51' --AND (TB004-TB005)-ISNULL(TE005,0) >0
			ORDER BY TA009


		--工单可补量
		SELECT SUM( CASE WHEN TB005-TB027>=0 THEN (TB004-TB005)-ISNULL(TE005,0) WHEN TB005-TB027<0 THEN (TB004-TB027)-ISNULL(TE005,0) ELSE 0 END )TTE
		FROM  MOCTB
		LEFT JOIN MOCTA ON TB001=TA001 AND TB002=TA002
		LEFT JOIN(SELECT ISNULL(SUM(TE005),0) TE005 ,TE004,TE011,TE012 FROM MOCTE  LEFT JOIN MOCTC ON TC001=TE001 AND TC002=TE002 WHERE TC009='N' GROUP BY TE011,TE012,TE004) AS A  ON TE011=MOCTA.TA001 AND TE012=TA002 AND TE004=TB003
		WHERE TA013='Y' AND TA011<>'Y' AND TA011<>'y' AND TA011<>'1' AND MOCTA.TA001+MOCTA.TA002 IN(SELECT TC004+TC005 FROM SFCTC WHERE TC004=MOCTA.TA001 AND TC005=MOCTA.TA002 AND TC022='Y')
		AND TB003=@PH  AND TB005<=TB004



	   --未审领料单
	   SELECT TE001,TE002,TE003,TE004,TE005,TE011,TE012
	    FROM MOCTE
	    LEFT JOIN MOCTC ON TC001=TE001 AND TC002=TE002
	    WHERE TC009='N'    AND TE004=@PH


	    --未审领料量
	    SELECT ISNULL(SUM(TE005),0) TE005 ,TE004,TE011,TE012
	    FROM MOCTE
	    LEFT JOIN MOCTC ON TC001=TE001 AND TC002=TE002
	    WHERE TC009='N'     AND TE004=@PH
	     GROUP BY TE011,TE012,TE004


		--库存总可补量
		select ISNULL(KYKC,0) KCKBL from V_INVMC_MOCTE_EDWIN where PH=@PH